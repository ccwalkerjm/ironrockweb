<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="MobileOptimized" content="320">
	<title>IronRock Insurance</title>

	<!--    @Scripts.Render("~/bundles/modernizr")-->
	<!--@Styles.Render("~/bundles/GlobalCSS")-->
	<link href="/assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/plugins/uniform/css/uniform.default.css" rel="stylesheet">
	<link href="/assets/plugins/bootstrap-datepicker/css/datepicker.css" rel="stylesheet">
	<!--    @Styles.Render("~/bundles/ThemeCSS")-->
	<link href="/assets/css/style-metronic.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">
	<link href="/assets/css/style-responsive.css" rel="stylesheet">
	<link href="/assets/css/plugins.css" rel="stylesheet">
	<link href="/assets/css/pages/tasks.css" rel="stylesheet">
	<link href="/assets/css/themes/default.css" rel="stylesheet">
	<link href="/assets/css/custom.css" rel="stylesheet">
	<link href="/assets/plugins/select2/select2_metro.css" rel="stylesheet">
	<!--@Scripts.Render("~/bundles/jquery")-->
	<script src="/Scripts/jquery-2.2.3.js"></script>
	<script src="/assets/plugins/jquery-migrate-1.2.1.min.js"></script>
	<script src="/assets/plugins/jquery-ui/jquery-ui-1.10.3.custom.min.js"></script>
	<script src="/assets/scripts/app.js"></script>
	<script src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
	<script src="/assets/plugins/bootstrap-hover-dropdown/twitter-bootstrap-hover-dropdown.min.js"></script>
	<script src="/assets/plugins/jquery-slimscroll/jquery.slimscroll.min.js"></script>
	<script src="/assets/plugins/jquery.blockui.min.js"></script>
	<script src="/assets/plugins/jquery.cokie.min.js"></script>
	<script src="/assets/plugins/uniform/jquery.uniform.min.js"></script>
	<script src="/assets/plugins/select2/select2.min.js"></script>

</head>

<body class="page-header-fixed">
	<div class="header navbar navbar-inverse navbar-fixed-top" style="background-color:rgb(231,231,231)!important;min-height:60px">
		<div class="header-inner">
			<a class="navbar-brand" href="/index.html">
				<img src="/assets/img/logo.png" id="logo" alt="" class="img-responsive" />
			</a>

			<a href="javascript:;" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
				<img src="/assets/img/menu-toggler.png" alt="" />
			</a>

			<ul class="nav navbar-nav pull-right">
			</ul>

		</div>
		<div class="navbar-collapse collapse">
			<ul class="nav navbar-nav">
			</ul>
		</div>
	</div>
	<div class="clearfix"></div>

	<div class="page-container">
		<div class="page-sidebar-wrapper" id="sidebar"></div>
		<div class="page-content-wrapper">
			<div class="page-content">
				<div class="message"></div>
				<section id="queryPolicySection" style="display:none">
					<h1>Policies</h1>
					<div class="row">
						<div class="col-md-4" id="searchColumn" style="display:none">
							<h2>Policy Search</h2>
							<form role="form">
								<div class="form-group">
									<label for="searchPolicyNo">Policy No</label>
									<input type="number" class="form-control" id="searchPolicyNo">
								</div>
								<div class="form-group">
									<label for="searchFirstname">First Name:</label>
									<input type="text" class="form-control" id="searchFirstname">
								</div>
								<div class="form-group">
									<label for="searchLastname">Last Name:</label>
									<input type="text" class="form-control" id="searchLastname">
								</div>
								<div class="form-group">
									<label for="searchDateFr">Date From:</label>
									<input type="date" class="form-control" id="searchDateFr">
								</div>
								<div class="form-group">
									<label for="searchDateTo">Date To:</label>
									<input type="date" class="form-control" id="searchDateTo">
								</div>
								<div class="form-group">
									<label for="searchInsuranceType">Type:</label>
									<select class="form-control" id="searchInsuranceType">
										<option value="">All Types</option>
										<option value="motor">Motor Vehicle</option>
										<option value="property">Home Property</option>
									</select>
								</div>
								<button type="button" class="btn btn-default" id="doSearch">Submit</button>
							</form>
						</div>
						<div class="col-md-8">
							<h2>Selected Policies</h2>
							<p>
								<button type="button" class="btn btn-link btn-sm pull-left" id="searchBtn">Toggle Search</button>
							</p>
							<table class="table" id="policiesTable">
								<thead></thead>
								<tbody></tbody>
							</table>
						</div>
					</div>
				</section>
				<section id="viewPolicySection" style="display:none">
					<div class="container">
						<h2>Policy</h2>
						<button class="btn btn-link" id="gotoPolicies" type="button">Return</button>
						<ul class="nav nav-tabs">
							<li class="active"><a data-toggle="tab" href="#summary">Summary</a></li>
							<li><a data-toggle="tab" href="#risk">Risks</a></li>
							<li><a data-toggle="tab" href="#Insured">Insured</a></li>
						</ul>
						<div class="tab-content">
							<div id="summary" class="tab-pane fade in active">
								<h3>Policy</h3>
								<input type="hidden" id="policy_id" />
								<dl class="dl-horizontal">
								</dl>
							</div>
							<div id="risk" class="tab-pane fade">
								<h3>Risks</h3>
								<table class="table">
									<thead></thead>
									<tbody></tbody>
								</table>
							</div>
							<div id="Insured" class="tab-pane fade">
								<h3>Insured</h3>
								<div id="InsuredDisplay">
								</div>
							</div>
						</div>
					</div>

				</section>
			</div>
		</div>
	</div>
	<div class="loadingModal">
		<!-- Place at bottom of page -->
	</div>
	<div class="footer" style="background-color:rgb(231,231,231)!important">
		<div class="footer-inner">
			2016 &copy; IronRock Insurance.
		</div>
		<div class="footer-tools">
			<span class="go-top">
			    <i class="fa fa-angle-up"></i>
		    </span>
		</div>
	</div>



	<script src="/Scripts/bootbox.js"></script>
	<script src="https://cdn.courserv.com/ironrock/scripts/accounting.min.js"></script>
	<script src="/Scripts/bootbox.js"></script>
	<!--Required Libraries-->
	<script src="/Scripts/aws/jsbn.js"></script>
	<script src="/Scripts/aws/jsbn2.js"></script>
	<script src="/Scripts/aws/sjcl.js"></script>
	<script src="/Scripts/aws/moment.min.js"></script>
	<script src="/Scripts/aws/aws-cognito-sdk.min.js"></script>
	<script src="/Scripts/aws/amazon-cognito-identity.min.js"></script>
	<script src="/Scripts/aws/aws-sdk-2.3.19.min.js"></script>
	<!--api gateway lib-->
	<script type="text/javascript" src="/Scripts/aws/apigClientLib/axios/dist/axios.standalone.js"></script>
	<script type="text/javascript" src="/Scripts/aws/apigClientLib/CryptoJS/rollups/hmac-sha256.js"></script>
	<script type="text/javascript" src="/Scripts/aws/apigClientLib/CryptoJS/rollups/sha256.js"></script>
	<script type="text/javascript" src="/Scripts/aws/apigClientLib/CryptoJS/components/hmac.js"></script>
	<script type="text/javascript" src="/Scripts/aws/apigClientLib/CryptoJS/components/enc-base64.js"></script>
	<script type="text/javascript" src="/Scripts/aws/apigClientLib/url-template/url-template.js"></script>
	<script type="text/javascript" src="/Scripts/aws/apigClientLib/apiGatewayCore/sigV4Client.js"></script>
	<script type="text/javascript" src="/Scripts/aws/apigClientLib/apiGatewayCore/apiGatewayClient.js"></script>
	<script type="text/javascript" src="/Scripts/aws/apigClientLib/apiGatewayCore/simpleHttpClient.js"></script>
	<script type="text/javascript" src="/Scripts/aws/apigClientLib/apiGatewayCore/utils.js"></script>
	<script type="text/javascript" src="/Scripts/aws/apigClient.js"></script>
	<!--Iron Rock Custom Library-->
	<script src="/Scripts/ironrockcloudservice.js"></script>
	<script src="/Scripts/index.js"></script>

	<script type="text/javascript">
		$(document).ready(function () {
			initPage(function (err, obj) {
				var today = new Date();
				var yyyy = today.getFullYear();
				var lastYear = yyyy - 1;
				$('#searchDateFr').val(lastYear + '-01-01');
				$('#searchDateTo').val(yyyy + '-12-31');
				var policyObj = localStorage.getItem('_ironrockPolicyObject');
				if (policyObj) {
					localStorage.removeItem('_ironrockPolicyObject');
					policyObj = JSON.parse(policyObj);
					populatePolicy(policyObj);
				} else {
					var policy_id = getQueryStringParams("policy");
					if (policy_id) {
						displayPolicy(policy_id + "==", obj);
					} else {
						doSearch(obj);
						$('#queryPolicySection').show();
						$('#viewPolicySection').hide();
					}
				}
			});


			//test api
			function displayPolicy(policy_id, obj) {
				setLoadingState(true);
				obj = obj || g_ironrock_service;
				obj.getPolicy(policy_id, function (err, data) {
					if (err) {
						display(err.message, err);
						setLoadingState(false);
					} else {
						setLoadingState(false);
						var policyObj = JSON.parse(data.Payload);
						if (policyObj.errorMessage) {
							display(policyObj.errorMessage, true);
						} else if (!policyObj.success) {
							display(policyObj.error_message, true);
						} else {
							populatePolicy(policyObj);
						}
					}
				});
			}


			function populatePolicy(policyObj) {
				$('#queryPolicySection').hide();
				$('#viewPolicySection').show();
				$('#summary dl').empty();
				$('#policy_id').val(policyObj.policy.policy_id);
				$('#summary dl').append('<dt>Policy Number</dt><dd>' + policyObj.policy.policy_number + '</dd>');
				$('#summary dl').append('<dt>Policy Prefix</dt><dd>' + policyObj.policy.policy_prefix + '</dd>');
				$('#summary dl').append('<dt>Start Date</dt><dd>' + policyObj.policy.start_date + '</dd>');
				$('#summary dl').append('<dt>End Date</dt><dd>' + policyObj.policy.end_date + '</dd>');
				$('#summary dl').append('<dt>Branch</dt><dd>' + policyObj.policy.branch + '</dd>');
				$('#summary dl').append('<dt>Date Signed</dt><dd>' + policyObj.policy.date_proposal_signed + '</dd>');
				$('#summary dl').append('<dt>Currency</dt><dd>' + policyObj.policy.currency + '</dd>');
				$('#summary dl').append('<dt>Agreed Value</dt><dd>' + (policyObj.policy.agreed_value ? "Yes" : "No") + '</dd>');
				$('#summary dl').append('<dt>Auto Renewal</dt><dd>' + (policyObj.policy.auto_renewal ? "Yes" : "No") + '</dd>');
				$('#summary dl').append('<dt>Memo</dt><dd>' + policyObj.policy.memo + '</dd>');
				$('#summary dl').append('<dt>Occupancy</dt><dd>' + policyObj.policy.occupancy + '</dd>');
				$('#summary dl').append('<dt>Usage Category</dt><dd>' + policyObj.policy.usage_category + '</dd>');




				populateInsureds(policyObj.policy.insureds, policyObj.global_names);
				//populate risks
				if (policyObj.risks[0].chassis_number)
					populateMVRisks(policyObj.risks);
				else
					populateHOCRisks(policyObj.risks);

				console.log(policyObj);
			}


			function populateInsureds(insureds, globalNames) {
				var insuredPlaceHolder = $('#InsuredDisplay');
				$.each(insureds, function (idx, insured) {
					var insuredDetail = getDetails(insured, globalNames);
					var dl = $("<dl/>").attr("class", "dl-horizontal");
					dl.append('<dt>Nationa ID:<dt><dd>' + insuredDetail.national_id + '</dd>');
					dl.append('<dt>Nationa ID Type:</dt><dd>' + insuredDetail.national_id_type + '</dd>');
					dl.append('<dt>First Name:</dt><dd>' + insuredDetail.first_name + '</dd>');
					dl.append('<dt>Last Name:</dt><dd>' + insuredDetail.last_name + '</dd>');
					dl.append('<dt>Middle Name:</dt><dd>' + insuredDetail.middle_name + '</dd>');
					dl.append('<dt>Maiden Name:</dt><dd>' + insuredDetail.maiden_name + '</dd>');
					dl.append('<dt>Nationality:</dt><dd>' + insuredDetail.nationality + '</dd>');
					dl.append('<dt>Occupation:</dt><dd>' + insuredDetail.occupation + '</dd>');
					dl.append('<dt>Place Of Birth:</dt><dd>' + insuredDetail.place_of_birth + '</dd>');
					dl.append('<dt>Gender:</dt><dd>' + insuredDetail.gender + '</dd>');
					dl.append('<dt>Email Address:</dt><dd>' + insuredDetail.email_address + '</dd>');
					dl.append('<dt>Title:</dt><dd>' + insuredDetail.title + '</dd>');
					dl.append('<dt>Date of Birth:</dt><dd>' + insuredDetail.dob + '</dd>');
					$.each(insuredDetail.phone_numbers, function (idx, phone) {
						dl.append('<dt>' + phone.type + ':</dt><dd>' + phone.phone_number + '</dd>');
					});
					$.each(insuredDetail.locations, function (idx, address) {
						dl.append('<dt>Main Location</dt><dd>' + address.is_main_location + '</dd>');
						dl.append('<dt>Type</dt><dd>' + address.street_type + '</dd>');
						dl.append('<dt>Street Number</dt><dd>' + address.street_number + '</dd>');
						dl.append('<dt>Street Name</dt><dd>' + address.street_name + '</dd>');
						dl.append('<dt>Town</dt><dd>' + address.town + '</dd>');
						dl.append('<dt>Unit Number</dt><dd>' + address.unit_number + '</dd>');
						dl.append('<dt>Parish</dt><dd>' + address.parish + '</dd>');
						dl.append('<dt>Postal/Zip Code</dt><dd>' + address.postal_zip_code + '</dd>');
						dl.append('<dt>Country</dt><dd>' + address.country + '</dd>');
					});
					insuredPlaceHolder.append(dl);
					insuredPlaceHolder.append("<hr/>");
				});
			}


			function getDetails(insured, globalNames) {
				var details = {};
				$.each(globalNames, function (idx, globalName) {
					if (insured.national_id == globalName.national_id && insured.national_id_type == globalName.national_id_type) {
						details = globalName;
					}
				});
				return details;
			}


			function populateMVRisks(risks) {
				var table = $('#risk table');
				table.find('thead').html('<tr><th>Plate&nbsp;No</th><th>Chassis&nbsp;No</th><th>Make</th><th>Model</th><th>Year</th><th align="right">Sum&nbsp;Insured</th><th></th></tr>');
				var tbody = table.find('tbody').empty();
				$.each(risks, function (idx, risk) {
					var certificateButton = '<button type="button" class="btn btn-link getCertificate" id="' + risk.risk_id + '">Certificate</button>';
					tbody.append('<tr><td>' + risk.registration_number + '</td><td>' + risk.chassis_number + '</td><td>' + risk.make + '</td><td>' + risk.model + '</td><td>' + risk.year + '</td><td>' + accounting.formatMoney(risk.sum_insured) + '</td><td>' + certificateButton + '</td></tr>');
				});
			}

			function populateHOCRisks(risks) {
				var table = $('#risk table');
				table.find('thead').html('<tr><th>Usage&nbsp;Code</th><th>Type</th><th>Year&nbsp;Built</th><th>Roof</th><th>Wall</th><th>Storeys</th><th align="right">Sum&nbsp;Insured</th><th></th></tr>');
				var tbody = table.find('tbody').empty();
				$.each(risks, function (idx, risk) {
					var certificateButton = '<button type="button" class="btn btn-link getCertificate" id="' + risk.risk_id + '">Certificate</button>';
					tbody.append('<tr><td>' + risk.usage_code + '</td><td>' + risk.risk_item_type + '</td><td>' + risk.building_year_built + '</td><td>' + risk.construction_of_roof + '</td><td>' + risk.construction_of_wall + '</td><td>' + risk.height_in_storeys + '</td><td>' + accounting.formatMoney(risk.sum_insured) + '</td><td>' + certificateButton + '</td></tr>');
				});
			}


			$('#gotoPolicies').click(function () {
				$('#queryPolicySection').show();
				$('#viewPolicySection').hide();
			});



			$('#policiesTable').on('click', '.select', function (e) {
				displayPolicy(e.target.id);
			});

			$('#searchBtn').click(function () {
				$('#searchColumn').toggle();
			});
			//search policies
			$('#doSearch').click(function () {
				doSearch();
			});


			$('#risk table').on('click', '.getCertificate', function (e) {
				var risk_id = e.target.id;
				var policy_id = $('#policy_id').val();
				setLoadingState(true);
				g_ironrock_service.getCertification(policy_id, risk_id, function (err, data) {
					setLoadingState(false);
					if (err) {
						bootbox.alert(err);
					} else {
						var result = JSON.parse(data.Payload);
						if (result.errorMessage) {
							display(result.errorMessage, true);
						} else if (result.error_message) {
							display(result.error_message, true);
						} else if (result.success) {
							var byteCharacters = atob(result.data.file_data);
							var byteNumbers = new Array(byteCharacters.length);
							for (var i = 0; i < byteCharacters.length; i++) {
								byteNumbers[i] = byteCharacters.charCodeAt(i);
							}
							var byteArray = new Uint8Array(byteNumbers);
							var file = new Blob([byteArray], {
								type: result.data.mime_type
							});
							var fileURL = URL.createObjectURL(file);
							window.open(fileURL);
						} else {


						}
					}
				});
			});


			function doSearch(obj) {
				var searchData = {};

				searchData.policyNo = $('#searchPolicyNo').val();
				searchData.firstName = $('#searchFirstname').val();
				searchData.lastName = $('#searchLastname').val();
				searchData.dateFr = $('#searchDateFr').val();
				searchData.dateTo = $('#searchDateTo').val();
				searchData.type = $('#searchInsuranceType').val();
				searchData.policy = "policy";
				var payload = JSON.stringify(searchData);

				setLoadingState(true);

				obj = obj || g_ironrock_service;
				obj.searchQuotes(payload, function (err, quoteList) {
					if (err) {
						setLoadingState(false);
						display(err.message, true);
						return;
					}
					if (!quoteList) {
						setLoadingState(false);
						display('No quotes returned!');
						return;
					}
					g_ironrock_service.listBrokers(function (err, data) {
						setLoadingState(false);
						var brokers = JSON.parse(data.Payload);
						quoteList = ConvertToJson(quoteList);
						var quotes = quoteList.sort(function (a, b) {
							return b.id - a.id;
						});
						// ascending order
						$('#policiesTable thead').html('<tr><th>Policy&nbsp;No</th><th>Date</th><th>First&nbsp;Name</th><th>Last&nbsp;Name</th><th>Type</th><th>Broker</th></tr>');
						var dlTable = $('#policiesTable tbody').html('');
						$.each(quotes, function (idx, policy) {
							var brokerName = policy.broker;
							$.each(brokers, function (i, b) {
								if (b.code == policy.broker) {
									brokerName = b.name;
								}
							});
							var date = new Date();
							var day = date.getDate(policy.startDate);
							var monthIndex = date.getMonth() + 1;
							var year = date.getFullYear();
							var dateFormat = day + '/' + monthIndex + '/' + year;
							dlTable.append('<tr><td>' + policy.policy_number + '</td><td>' +
								dateFormat + '</td><td>' +
								policy.firstName + '</td><td>' +
								policy.lastName + '</td><td>' +
								policy.type + '</td><td>' +
								brokerName + '</td><td><button class="btn btn-link select" id="' +
								policy.policy_id + '">Select</button></td></tr>');
						});
					});
				});
			}
		});
	</script>




</body>

</html>
